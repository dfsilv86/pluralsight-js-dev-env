<databaseChangeLog
		xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
		xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd
		http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<changeSet id="ra2016-2-PR_GeraSugestaoPedidoCD" author="edapper">
		<sql stripComments="false" endDelimiter="">
			<![CDATA[  
		
			ALTER PROCEDURE [dbo].[PR_GeraSugestaoPedidoCD] @DataSugestao DATE = NULL
			AS
			BEGIN
				DECLARE @blExisteSugestao BIT

				IF (@DataSugestao IS NULL)
				BEGIN
					SELECT @DataSugestao = GETDATE();
				END

				DECLARE @TpWeek AS INT = dbo.fnObterTpWeek(@DataSugestao);

				EXEC STAGE_PR_TRUNCATE 'SugestaoPedidoCD'

				INSERT INTO STAGE_SugestaoPedidoCD (
					idFornecedorParametro
					,idItemDetalhePedido
					,idItemDetalheSugestao
					,idCD
					,dtPedido
					,dtEnvioPedido
					,dtCancelamentoPedido
					,dtCancelamentoPedidoOriginal
					,dtInicioForecast
					,dtFimForecast
					,tpWeek
					,tpInterval
					,cdReviewDate
					,vlReviewTime
					,vlLeadTime
					,qtVendorPackage
					,vlEstoqueSeguranca
					,tempoMinimoCD
					,tpCaixaFornecedor
					,vlPesoLiquido
					,vlTipoReabastecimento
					,vlCusto
					,qtdPackCompra
					,qtdPackCompraOriginal
					,qtdOnHand
					,qtdOnOrder
					,qtdForecast
					,qtdPipeline
					,IdOrigemDadosCalculo
					,qtdDiasAbastecimento
					,cdCd
					,cdItemSaida
					)
				SELECT IDE.IDFornecedorParametro
					,IDE.IdItemDetalhe IdItemDetalhePedido
					,ISNULL(IDS.IdItemDetalhe, IDE.IdItemDetalhe) IdItemDetalheSugestao
					,RIC.idCD
					,@DataSugestao dtPedido
					,@DataSugestao dtEnvioPedido
					,CONVERT(DATETIME, @DataSugestao) + COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + 1 dtCancelamentoPedido
					,CONVERT(DATETIME, @DataSugestao) + COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + 1 dtCancelamentoPedidoOriginal
					,CONVERT(DATETIME, @DataSugestao) + COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) dtInicioForecast
					,CONVERT(DATETIME, @DataSugestao) + COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + CASE 
						WHEN COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + ISNULL(RIC.vlEstoqueSeguranca, 0) + (
								CASE 
									WHEN DATEPART(WEEKDAY, GETDATE()) < dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
										THEN dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL) - DATEPART(WEEKDAY, GETDATE())
									ELSE 7 - DATEPART(WEEKDAY, GETDATE()) + dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
									END
								) < ISNULL(IDE.tempoMinimoCd, 0)
							THEN COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + ISNULL(RIC.vlEstoqueSeguranca, 0) + (
									CASE 
										WHEN DATEPART(WEEKDAY, GETDATE()) < dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
											THEN dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL) - DATEPART(WEEKDAY, GETDATE())
										ELSE 7 - DATEPART(WEEKDAY, GETDATE()) + dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
										END
									)
						ELSE ISNULL(IDE.tempoMinimoCd, 0)
						END dtFimForecast
					,COALESCE(FCP.TPWEEK, FP.TPWEEK) TPWEEK
					,COALESCE(FCP.TPINTERVAL, FP.TPINTERVAL) TPINTERVAL
					,CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR) CDREVIEWDATE
					,CASE 
						WHEN DATEPART(WEEKDAY, GETDATE()) < dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
							THEN dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL) - DATEPART(WEEKDAY, GETDATE())
						ELSE 7 - DATEPART(WEEKDAY, GETDATE()) + dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
						END ReviewTime
					,COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) VLLEADTIME
					,IDE.qtVendorPackage
					,ISNULL(RIC.vlEstoqueSeguranca, 0)
					,ISNULL(IDE.tempoMinimoCd, 0)
					,IDE.tpCaixaFornecedor
					,ISNULL(IDE.vlPesoLiquido, 0)
					,RIC.vlTipoReabastecimento
					,ISNULL(IC.BuyPrice,0) vlCusto
					,0 qtdPackCompra
					,0 qtdPackCompraOriginal
					,ISNULL(IEC.qtdOnHand, 0)
					,ISNULL(IEC.qtdOnOrder, 0)
					,0 qtdForecast
					,CASE 
						WHEN ISNULL(IEC.qtdOnHand, 0) + ISNULL(IEC.qtdOnOrder, 0) < 0
							THEN 0
						ELSE ISNULL(IEC.qtdOnHand, 0) + ISNULL(IEC.qtdOnOrder, 0)
						END qtdPipeline
					,CASE 
						WHEN FCP.idFornecedorCDParametro IS NULL
							THEN 3
						ELSE 2
						END IdOrigemDadosCalculo
					,CASE 
						WHEN COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + ISNULL(RIC.vlEstoqueSeguranca, 0) + (
								CASE 
									WHEN DATEPART(WEEKDAY, GETDATE()) < dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
										THEN dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL) - DATEPART(WEEKDAY, GETDATE())
									ELSE 7 - DATEPART(WEEKDAY, GETDATE()) + dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
									END
								) < ISNULL(IDE.tempoMinimoCd, 0)
							THEN COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + ISNULL(RIC.vlEstoqueSeguranca, 0) + (
									CASE 
										WHEN DATEPART(WEEKDAY, GETDATE()) < dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
											THEN dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL) - DATEPART(WEEKDAY, GETDATE())
										ELSE 7 - DATEPART(WEEKDAY, GETDATE()) + dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
										END
									)
						ELSE ISNULL(IDE.tempoMinimoCd, 0)
						END
					,cd.cdCD
					,IDS.cdItem
				FROM RelacaoItemCD RIC
				JOIN CD cd
					ON cd.IDCD = RIC.idCD
				LEFT JOIN ItemEstoqueCD IEC
					ON IEC.idCD = RIC.idCD
						AND IEC.idItemDetalhe = RIC.idItemEntrada
				LEFT JOIN ItemDetalhe IDE
					ON IDE.IDItemDetalhe = RIC.idItemEntrada
						AND IDE.tpStatus = 'A'
						AND IDE.cdSistema = 1
						AND IDE.blItemTransferencia = 0
						AND IDE.blAtivo = 1
						AND IDE.IDFornecedorParametro IS NOT NULL
				JOIN ItemDetalhe IDS
					ON IDS.IdItemDetalhe = RIC.idItemSaida
						AND IDS.tpStatus = 'A'
						AND IDS.blAtivo = 1
						AND IDE.blItemTransferencia = 0
				JOIN FornecedorParametro FP
					ON FP.IDFornecedorParametro = ISNULL(IDE.idFornecedorParametro, IDS.idFornecedorParametro)
						AND FP.cdStatusVendor = 'A'
						AND FP.tpStoreApprovalRequired IN ('Y', 'R')
				JOIN Fornecedor F
					ON F.IDFornecedor = FP.IDFornecedor
						AND F.blAtivo = 1
				LEFT JOIN FornecedorCDParametro FCP
					ON FCP.IDFornecedorParametro = FP.IDFornecedorParametro
						AND FCP.IDCD = RIC.idCD
				LEFT JOIN ItemCustoCD IC
					ON IC.idCD = RIC.idCD
						AND IC.idItemDetalhe = RIC.idItemEntrada
						AND IC.dtRecebimento = (
							SELECT MAX(dtRecebimento)
							FROM ItemCustoCD
							WHERE IC.idCD = RIC.idCD
								AND IC.idItemDetalhe = RIC.idItemEntrada
							)
				WHERE RIC.vlTipoReabastecimento IN (20, 22)
					AND CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS NVARCHAR) LIKE '%' + CAST(DATEPART(WEEKDAY, @DataSugestao) AS NVARCHAR) + '%'
					AND (
						COALESCE(FCP.tpInterval, FP.tpInterval) IN (1, 0)
						OR (
							COALESCE(FCP.tpInterval, FP.tpInterval) = @tpWeek
							AND COALESCE(FCP.tpWeek, FP.tpWeek) = 2
							)
						)

				EXEC PR_CalcularForecastCD

				UPDATE S
				SET qtdForecast = FS.ValorForecast
					,qtdPackCompraOriginal = CONVERT(INT, CASE 
							WHEN (
									CASE 
										WHEN s.tpCaixaFornecedor = 'F'
											AND qtVendorPackage <> 0
											THEN (FS.ValorForecast - qtdPipeline) / qtVendorPackage
										WHEN s.tpCaixaFornecedor = 'V'
											AND vlPesoLiquido <> 0
											THEN (FS.ValorForecast - qtdPipeline) / vlPesoLiquido
										ELSE (FS.ValorForecast - qtdPipeline)
										END
									) < 0
								THEN 0
							ELSE (
									CASE 
										WHEN s.tpCaixaFornecedor = 'F'
											AND qtVendorPackage <> 0
											THEN (FS.ValorForecast - qtdPipeline) / qtVendorPackage
										WHEN s.tpCaixaFornecedor = 'V'
											AND vlPesoLiquido <> 0
											THEN (FS.ValorForecast - qtdPipeline) / vlPesoLiquido
										ELSE (FS.ValorForecast - qtdPipeline)
										END
									)
							END)
				FROM STAGE_SugestaoPedidoCD S
				INNER JOIN STAGE_ForecastSugestaoCd FS
					ON FS.IdItemDetalhePedido = S.idItemDetalhePedido
						AND FS.IdItemDetalheSugestao = S.idItemDetalheSugestao
						AND Fs.idcd = S.idCD

				SELECT TOP 1 @blExisteSugestao = 1
				FROM SugestaoPedidoCD
				WHERE dtPedido = @DataSugestao

				IF ISNULL(@blExisteSugestao, 0) = 0
					INSERT INTO SugestaoPedidoCD (
						idFornecedorParametro
						,idItemDetalhePedido
						,idItemDetalheSugestao
						,idCD
						,dtPedido
						,dtEnvioPedido
						,dtCancelamentoPedido
						,dtCancelamentoPedidoOriginal
						,dtInicioForecast
						,dtFimForecast
						,tpWeek
						,tpInterval
						,cdReviewDate
						,vlReviewTime
						,vlLeadTime
						,qtVendorPackage
						,vlEstoqueSeguranca
						,tempoMinimoCD
						,tpCaixaFornecedor
						,vlPesoLiquido
						,vlTipoReabastecimento
						,vlCusto
						,qtdPackCompra
						,qtdPackCompraOriginal
						,qtdOnHand
						,qtdOnOrder
						,qtdForecast
						,qtdPipeline
						,IdOrigemDadosCalculo
						)
					SELECT idFornecedorParametro
						,idItemDetalhePedido
						,idItemDetalheSugestao
						,idCD
						,dtPedido
						,dtEnvioPedido
						,dtCancelamentoPedido
						,dtCancelamentoPedidoOriginal
						,dtInicioForecast
						,dtFimForecast
						,tpWeek
						,tpInterval
						,cdReviewDate
						,vlReviewTime
						,vlLeadTime
						,qtVendorPackage
						,vlEstoqueSeguranca
						,tempoMinimoCD
						,tpCaixaFornecedor
						,vlPesoLiquido
						,vlTipoReabastecimento
						,vlCusto
						,qtdPackCompra
						,qtdPackCompraOriginal
						,qtdOnHand
						,qtdOnOrder
						,qtdForecast
						,qtdPipeline
						,IdOrigemDadosCalculo
					FROM STAGE_SugestaoPedidoCD
					WHERE dtPedido = @DataSugestao
			END
				
			]]>
		</sql>
		<rollback>
			<sql stripComments="false" endDelimiter="">
				<![CDATA[ 
				
				ALTER PROCEDURE [dbo].[PR_GeraSugestaoPedidoCD] @DataSugestao DATE = NULL
				AS
				BEGIN
					DECLARE @TpWeek INT
						,@blExisteSugestao BIT

					SELECT @TpWeek = DV.dsText
					FROM CWIDOMAINVALUE DV
					JOIN CWIDOMAIN D
						ON D.IDDOMAIN = DV.IDDOMAIN
					WHERE D.nmDomain = 'SemanaWalMart'
						AND DV.dsValue = 'W'

					IF @DataSugestao IS NULL
						SET @DataSugestao = GETDATE()
					ELSE IF ABS(DATEPART(wk, GETDATE() + 20) - DATEPART(wk, GETDATE())) % 2 = 1
						SET @TpWeek = CASE @TpWeek
								WHEN 1
									THEN 2
								ELSE 1
								END

					EXEC STAGE_PR_TRUNCATE 'SugestaoPedidoCD'

					INSERT INTO STAGE_SugestaoPedidoCD (
						idFornecedorParametro
						,idItemDetalhePedido
						,idItemDetalheSugestao
						,idCD
						,dtPedido
						,dtEnvioPedido
						,dtCancelamentoPedido
						,dtCancelamentoPedidoOriginal
						,dtInicioForecast
						,dtFimForecast
						,tpWeek
						,tpInterval
						,cdReviewDate
						,vlReviewTime
						,vlLeadTime
						,qtVendorPackage
						,vlEstoqueSeguranca
						,tempoMinimoCD
						,tpCaixaFornecedor
						,vlPesoLiquido
						,vlTipoReabastecimento
						,vlCusto
						,qtdPackCompra
						,qtdPackCompraOriginal
						,qtdOnHand
						,qtdOnOrder
						,qtdForecast
						,qtdPipeline
						,IdOrigemDadosCalculo
						,qtdDiasAbastecimento
						,cdCd
						,cdItemSaida
						)
					SELECT IDE.IDFornecedorParametro
						,IDE.IdItemDetalhe IdItemDetalhePedido
						,ISNULL(IDS.IdItemDetalhe, IDE.IdItemDetalhe) IdItemDetalheSugestao
						,RIC.idCD
						,@DataSugestao dtPedido
						,@DataSugestao dtEnvioPedido
						,CONVERT(DATETIME, @DataSugestao) + COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + 1 dtCancelamentoPedido
						,CONVERT(DATETIME, @DataSugestao) + COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + 1 dtCancelamentoPedidoOriginal
						,CONVERT(DATETIME, @DataSugestao) + COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) dtInicioForecast
						,CONVERT(DATETIME, @DataSugestao) + COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + CASE 
							WHEN COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + ISNULL(RIC.vlEstoqueSeguranca, 0) + (
									CASE 
										WHEN DATEPART(WEEKDAY, GETDATE()) < dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
											THEN dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL) - DATEPART(WEEKDAY, GETDATE())
										ELSE 7 - DATEPART(WEEKDAY, GETDATE()) + dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
										END
									) < ISNULL(IDE.tempoMinimoCd, 0)
								THEN COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + ISNULL(RIC.vlEstoqueSeguranca, 0) + (
										CASE 
											WHEN DATEPART(WEEKDAY, GETDATE()) < dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
												THEN dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL) - DATEPART(WEEKDAY, GETDATE())
											ELSE 7 - DATEPART(WEEKDAY, GETDATE()) + dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
											END
										)
							ELSE ISNULL(IDE.tempoMinimoCd, 0)
							END dtFimForecast
						,COALESCE(FCP.TPWEEK, FP.TPWEEK) TPWEEK
						,COALESCE(FCP.TPINTERVAL, FP.TPINTERVAL) TPINTERVAL
						,CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR) CDREVIEWDATE
						,CASE 
							WHEN DATEPART(WEEKDAY, GETDATE()) < dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
								THEN dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL) - DATEPART(WEEKDAY, GETDATE())
							ELSE 7 - DATEPART(WEEKDAY, GETDATE()) + dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
							END ReviewTime
						,COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) VLLEADTIME
						,IDE.qtVendorPackage
						,ISNULL(RIC.vlEstoqueSeguranca, 0)
						,ISNULL(IDE.tempoMinimoCd, 0)
						,IDE.tpCaixaFornecedor
						,ISNULL(IDE.vlPesoLiquido, 0)
						,RIC.vlTipoReabastecimento
						,ISNULL(IC.BuyPrice,0) vlCusto
						,0 qtdPackCompra
						,0 qtdPackCompraOriginal
						,ISNULL(IEC.qtdOnHand, 0)
						,ISNULL(IEC.qtdOnOrder, 0)
						,0 qtdForecast
						,CASE 
							WHEN ISNULL(IEC.qtdOnHand, 0) + ISNULL(IEC.qtdOnOrder, 0) < 0
								THEN 0
							ELSE ISNULL(IEC.qtdOnHand, 0) + ISNULL(IEC.qtdOnOrder, 0)
							END qtdPipeline
						,CASE 
							WHEN FCP.idFornecedorCDParametro IS NULL
								THEN 3
							ELSE 2
							END IdOrigemDadosCalculo
						,CASE 
							WHEN COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + ISNULL(RIC.vlEstoqueSeguranca, 0) + (
									CASE 
										WHEN DATEPART(WEEKDAY, GETDATE()) < dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
											THEN dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL) - DATEPART(WEEKDAY, GETDATE())
										ELSE 7 - DATEPART(WEEKDAY, GETDATE()) + dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
										END
									) < ISNULL(IDE.tempoMinimoCd, 0)
								THEN COALESCE(FCP.VLLEADTIME, FP.VLLEADTIME, 0) + ISNULL(RIC.vlEstoqueSeguranca, 0) + (
										CASE 
											WHEN DATEPART(WEEKDAY, GETDATE()) < dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
												THEN dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL) - DATEPART(WEEKDAY, GETDATE())
											ELSE 7 - DATEPART(WEEKDAY, GETDATE()) + dbo.fnRetornaProximoReviewDate(CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS VARCHAR), NULL)
											END
										)
							ELSE ISNULL(IDE.tempoMinimoCd, 0)
							END
						,cd.cdCD
						,IDS.cdItem
					FROM RelacaoItemCD RIC
					JOIN CD cd
						ON cd.IDCD = RIC.idCD
					LEFT JOIN ItemEstoqueCD IEC
						ON IEC.idCD = RIC.idCD
							AND IEC.idItemDetalhe = RIC.idItemEntrada
					LEFT JOIN ItemDetalhe IDE
						ON IDE.IDItemDetalhe = RIC.idItemEntrada
							AND IDE.tpStatus = 'A'
							AND IDE.cdSistema = 1
							AND IDE.blItemTransferencia = 0
							AND IDE.blAtivo = 1
							AND IDE.IDFornecedorParametro IS NOT NULL
					JOIN ItemDetalhe IDS
						ON IDS.IdItemDetalhe = RIC.idItemSaida
							AND IDS.tpStatus = 'A'
							AND IDS.blAtivo = 1
							AND IDE.blItemTransferencia = 0
					JOIN FornecedorParametro FP
						ON FP.IDFornecedorParametro = ISNULL(IDE.idFornecedorParametro, IDS.idFornecedorParametro)
							AND FP.cdStatusVendor = 'A'
							AND FP.tpStoreApprovalRequired IN ('Y', 'R')
					JOIN Fornecedor F
						ON F.IDFornecedor = FP.IDFornecedor
							AND F.blAtivo = 1
					LEFT JOIN FornecedorCDParametro FCP
						ON FCP.IDFornecedorParametro = FP.IDFornecedorParametro
							AND FCP.IDCD = RIC.idCD
					LEFT JOIN ItemCustoCD IC
						ON IC.idCD = RIC.idCD
							AND IC.idItemDetalhe = RIC.idItemEntrada
							AND IC.dtRecebimento = (
								SELECT MAX(dtRecebimento)
								FROM ItemCustoCD
								WHERE IC.idCD = RIC.idCD
									AND IC.idItemDetalhe = RIC.idItemEntrada
								)
					WHERE RIC.vlTipoReabastecimento IN (20, 22)
						AND CAST(COALESCE(FCP.cdReviewDate, FP.cdReviewDate) AS NVARCHAR) LIKE '%' + CAST(DATEPART(WEEKDAY, @DataSugestao) AS NVARCHAR) + '%'
						AND (
							COALESCE(FCP.tpInterval, FP.tpInterval) IN (1, 0)
							OR (
								COALESCE(FCP.tpInterval, FP.tpInterval) = @tpWeek
								AND COALESCE(FCP.tpWeek, FP.tpWeek) = 2
								)
							)

					EXEC PR_CalcularForecastCD

					UPDATE S
					SET qtdForecast = FS.ValorForecast
						,qtdPackCompraOriginal = CONVERT(INT, CASE 
								WHEN (
										CASE 
											WHEN s.tpCaixaFornecedor = 'F'
												AND qtVendorPackage <> 0
												THEN (FS.ValorForecast - qtdPipeline) / qtVendorPackage
											WHEN s.tpCaixaFornecedor = 'V'
												AND vlPesoLiquido <> 0
												THEN (FS.ValorForecast - qtdPipeline) / vlPesoLiquido
											ELSE (FS.ValorForecast - qtdPipeline)
											END
										) < 0
									THEN 0
								ELSE (
										CASE 
											WHEN s.tpCaixaFornecedor = 'F'
												AND qtVendorPackage <> 0
												THEN (FS.ValorForecast - qtdPipeline) / qtVendorPackage
											WHEN s.tpCaixaFornecedor = 'V'
												AND vlPesoLiquido <> 0
												THEN (FS.ValorForecast - qtdPipeline) / vlPesoLiquido
											ELSE (FS.ValorForecast - qtdPipeline)
											END
										)
								END)
					FROM STAGE_SugestaoPedidoCD S
					INNER JOIN STAGE_ForecastSugestaoCd FS
						ON FS.IdItemDetalhePedido = S.idItemDetalhePedido
							AND FS.IdItemDetalheSugestao = S.idItemDetalheSugestao
							AND Fs.idcd = S.idCD

					SELECT TOP 1 @blExisteSugestao = 1
					FROM SugestaoPedidoCD
					WHERE dtPedido = @DataSugestao

					IF ISNULL(@blExisteSugestao, 0) = 0
						INSERT INTO SugestaoPedidoCD (
							idFornecedorParametro
							,idItemDetalhePedido
							,idItemDetalheSugestao
							,idCD
							,dtPedido
							,dtEnvioPedido
							,dtCancelamentoPedido
							,dtCancelamentoPedidoOriginal
							,dtInicioForecast
							,dtFimForecast
							,tpWeek
							,tpInterval
							,cdReviewDate
							,vlReviewTime
							,vlLeadTime
							,qtVendorPackage
							,vlEstoqueSeguranca
							,tempoMinimoCD
							,tpCaixaFornecedor
							,vlPesoLiquido
							,vlTipoReabastecimento
							,vlCusto
							,qtdPackCompra
							,qtdPackCompraOriginal
							,qtdOnHand
							,qtdOnOrder
							,qtdForecast
							,qtdPipeline
							,IdOrigemDadosCalculo
							)
						SELECT idFornecedorParametro
							,idItemDetalhePedido
							,idItemDetalheSugestao
							,idCD
							,dtPedido
							,dtEnvioPedido
							,dtCancelamentoPedido
							,dtCancelamentoPedidoOriginal
							,dtInicioForecast
							,dtFimForecast
							,tpWeek
							,tpInterval
							,cdReviewDate
							,vlReviewTime
							,vlLeadTime
							,qtVendorPackage
							,vlEstoqueSeguranca
							,tempoMinimoCD
							,tpCaixaFornecedor
							,vlPesoLiquido
							,vlTipoReabastecimento
							,vlCusto
							,qtdPackCompra
							,qtdPackCompraOriginal
							,qtdOnHand
							,qtdOnOrder
							,qtdForecast
							,qtdPipeline
							,IdOrigemDadosCalculo
						FROM STAGE_SugestaoPedidoCD
						WHERE dtPedido = @DataSugestao
				END
				
				]]>
			</sql>
		</rollback>
	</changeSet>
</databaseChangeLog>

